# PointsYeah MCP Server - Implementation Notes

## Architecture Overview

This MCP server integrates with PointsYeah, a travel rewards search engine. The flight search uses a Playwright-based approach to interact with the PointsYeah website:

1. **Live Search API** (`api2.pointsyeah.com`) - Task-based flight search with encrypted requests
   - `create_task`: Creates a search task (requires encrypted payload, handled by Playwright)
   - `fetch_result`: Polls for incremental results via plain HTTP POST
2. **User APIs** (`api2.pointsyeah.com`) - History and other user data

### Why Playwright?

The live search API (`api2.pointsyeah.com/flight/search/create_task`) requires an encrypted request payload generated by PointsYeah's client-side JavaScript (CryptoJS/AES). Rather than reverse-engineering the encryption, we use Playwright to:

1. Set Cognito auth cookies in a headless browser
2. Navigate to the PointsYeah search page with the desired parameters
3. Intercept the encrypted `create_task` API response to get a `task_id`
4. Poll `fetch_result` via plain HTTP for incremental results

## Key Design Decisions

### Static Tool Registration

- All tools (`set_refresh_token`, `search_flights`, `get_search_history`) are always registered at startup
- Auth-requiring tools check `getServerState().authenticated` at call time
- When not authenticated, auth-requiring tools return: "Authentication required. Please call the set_refresh_token tool first."
- This approach works with all MCP clients, including those that don't support `tools/list_changed` notifications (like Claude Code SDK)
- Auth state is tracked in `state.ts` (module-level singleton)

### Authentication

- Uses AWS Cognito `REFRESH_TOKEN_AUTH` flow
- Tokens are refreshed lazily - only when within 5 minutes of expiry
- The refresh token itself does not rotate; the same token works until it expires
- All authenticated API calls use `withAuth()` which automatically retries on 401
- Token revocation is detected by checking error messages for known patterns

### Flight Search (Two-Step)

1. **Create Task** (via Playwright): Navigate to PointsYeah search page, let the website encrypt the request, intercept the `create_task` response to get a `task_id`
2. **Poll Results** (via HTTP): POST to `fetch_result` with `task_id` every 3 seconds until all sub-tasks complete (up to 6 minutes)

## API Domains

- `cognito-idp.us-east-1.amazonaws.com` - Authentication
- `api2.pointsyeah.com` - Live search (create_task, fetch_result) and User APIs (search history)

## Environment Variables

- `POINTSYEAH_REFRESH_TOKEN` (optional) - Cognito refresh token (~1784 char JWE). If not set, server starts in unauthenticated mode.
- `ENABLED_TOOLGROUPS` (optional) - Tool group filter

## Key Files

- `shared/src/state.ts` - Auth state management (authenticated flag, refresh token)
- `shared/src/tools.ts` - Static tool registration with auth check wrappers
- `shared/src/tools/set-refresh-token.ts` - The `set_refresh_token` tool with token validation
- `shared/src/server.ts` - `PointsYeahClient` with Playwright search + HTTP polling
- `shared/src/pointsyeah-client/lib/search.ts` - Playwright-based search task creation (cookie setup, URL building, response interception)
- `shared/src/pointsyeah-client/lib/fetch-results.ts` - HTTP polling for search results
- `shared/src/pointsyeah-client/lib/auth.ts` - Cognito token refresh
- `shared/src/pointsyeah-client/lib/user-api.ts` - User API calls (search history)
- `local/src/index.ts` - Entry point with optional env token validation on startup

## Testing

- Functional tests mock the `IPointsYeahClient` interface and test auth state transitions
- Integration tests use `createIntegrationMockPointsYeahClient` with `TestMCPClient`
- Manual tests are designed to always pass regardless of token availability:
  - Unauthenticated tests verify the auth-needed UX (no token required)
  - Authenticated tests gracefully handle expired/revoked tokens
